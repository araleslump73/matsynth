<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatSynth Multitimbrico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #121212; color: #e0e0e0; font-family: sans-serif; font-size: 0.9rem; }
        .card { background: #1e1e1e; border: 1px solid #333; margin-bottom: 15px; }
        .slider-label { font-size: 0.75rem; color: #00ff88; margin-bottom: 2px; display: block; text-transform: uppercase; }
        .form-select { background-color: #2a2a2a; color: white; border: 1px solid #444; font-size: 0.85rem; }
        
        /* Stili Mixer */
        .mixer-container { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .channel-row { 
            background: #252525; 
            border-radius: 6px; 
            padding: 6px; 
            margin-bottom: 4px; 
            border-left: 4px solid #00ff88;
        }
        .chan-label { font-weight: bold; color: #ffc107; line-height: 31px; }
        
        /* Personalizzazione scrollbar per Pi Zero */
        .mixer-container::-webkit-scrollbar { width: 8px; }
        .mixer-container::-webkit-scrollbar-track { background: #1a1a1a; }
        .mixer-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body class="container py-3">
    <h3 class="text-center text-success mb-3">MatSynth</h3>

    <div class="d-grid mb-3">
        <button class="btn btn-warning btn-sm fw-bold" onclick="syncWithSynth()">üîÑ AGGIORNA STATO DA TASTIERA</button>
    </div>

<div class="card p-3 border-success" style="border-width: 2px;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="slider-label mb-0" id="gain-slider" style="color: #00ff88; font-size: 1rem;">üîä MASTER VOLUME (GAIN)</label>
        <span id="gain-value" class="badge bg-success">1.0</span>
    </div>
    <input type="range" class="form-range" min="0" max="3" step="0.1" value="1" 
           oninput="updateGain(this.value)">
    <div class="d-flex justify-content-between text-muted" style="font-size: 0.7rem;">
        <span>MUTE</span>
        <span>NORMAL (1.0)</span>
        <span>BOOST</span>
    </div>
</div>

    <div class="card p-3">
        <h6 class="text-white border-bottom border-secondary pb-2 mb-3">MIDI CHANNELS</h6>
        <div id="mixer" class="mixer-container">
            <div class="text-center p-3 text-muted">Inizializzazione mixer...</div>
        </div>
    </div>

    <div class="card p-3">
        <label class="slider-label">Canale target per controlli: <span id="target-ch-display" class="text-white">1</span></label>
        <div class="row">
            <div class="col-6 mb-3">
                <label class="slider-label">ATTACK (CC 73)</label>
                <input type="range" class="form-range" min="0" max="127" value="64" oninput="updateCC(73, this.value)">
            </div>
            <div class="col-6 mb-3">
                <label class="slider-label">RELEASE (CC 72)</label>
                <input type="range" class="form-range" min="0" max="127" value="64" oninput="updateCC(72, this.value)">
            </div>
            <div class="col-6">
                <label class="slider-label">CUTOFF (CC 74)</label>
                <input type="range" class="form-range" min="0" max="127" value="127" oninput="updateCC(74, this.value)">
            </div>
            <div class="col-6">
                <label class="slider-label">RESO (CC 71)</label>
                <input type="range" class="form-range" min="0" max="127" value="0" oninput="updateCC(71, this.value)">
            </div>
        </div>
    </div>

    <div class="card p-3">
        <label class="slider-label">RIVERBERO MASTER</label>
        <input type="range" class="form-range mb-2" min="0" max="1" step="0.05" onchange="setEff('reverb.level', this.value)">
        <label class="slider-label">CHORUS MASTER</label>
        <input type="range" class="form-range" min="0" max="1" step="0.05" onchange="setEff('chorus.level', this.value)">
    </div>
<div class="card p-3 mb-3 border-info">
    <label class="text-info">üìÅ SELEZIONA SOUNDFONT</label>
    <select id="sf2-select" class="form-select bg-dark text-white" onchange="changeSF2(this.value)">
        </select>
</div>
    <script>
        let instrumentData = [];
        let activeControlChannel = 0; // Il canale su cui agiscono gli slider CC

        // Inizializzazione Mixer
        async function setupMixer() {
            try {
                const res = await fetch('/get_instruments');
                instrumentData = await res.json();
                
                const mixer = document.getElementById('mixer');
                mixer.innerHTML = '';

                for (let i = 0; i < 16; i++) {
                    const row = document.createElement('div');
                    row.className = 'row channel-row mx-0';
                    row.onclick = () => setControlChannel(i); // Clicca la riga per assegnare gli slider
                    
                    row.innerHTML = `
                        <div class="col-2 chan-label">CH${i+1}</div>
                        <div class="col-10">
                            <select id="select-ch-${i}" class="form-select" onchange="changeInst(${i}, this.value)">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                    `;
                    mixer.appendChild(row);
                    populateDropdown(document.getElementById(`select-ch-${i}`));
                }
                
                syncWithSynth();
            } catch(e) { console.error("Errore Setup:", e); }
        }

        function populateDropdown(dropdown) {
            dropdown.innerHTML = '<option value="">-- Seleziona Suono --</option>';
            instrumentData.forEach(inst => {
                if (!inst.includes('-')) return;
                const parts = inst.split('-');
                const bank = parts[0].trim();
                const prog = parts[1].trim().split(' ')[0];
                
                let opt = document.createElement('option');
                opt.value = `${bank},${prog}`;
                opt.innerText = inst;
                dropdown.appendChild(opt);
            });
        }

        // Cambio Canale per Slider
        function setControlChannel(chan) {
            activeControlChannel = chan;
            document.getElementById('target-ch-display').innerText = chan + 1;
            // Evidenzia visivamente la riga (opzionale)
            document.querySelectorAll('.channel-row').forEach((r, idx) => {
                r.style.borderColor = (idx === chan) ? "#ffc107" : "#00ff88";
            });
        }

        // Azioni
        async function changeInst(chan, val) {
            if (!val) return;
            const [bank, prog] = val.split(',');
            setControlChannel(chan);
            await fetch(`/select_prog/${chan}/${bank}/${prog}`);
        }

        function updateCC(cc, val) {
            fetch(`/cc/${activeControlChannel}/${cc}/${val}`);
        }

        function setEff(type, val) {
            fetch(`/set_effect/${type}/${val}`);
        }

function updateGain(val) {
    // Aggiorna il numeretto visibile accanto all'etichetta
    document.getElementById('gain-value').innerText = parseFloat(val).toFixed(1);
    
    // Invia il comando al server
    // Nota: 'gain' non ha bisogno di prefissi particolari perch√© la rotta 
    // in app.py aggiunge gi√† 'synth.'
    setEff('gain', val);
}

 
async function syncWithSynth() {
    const btn = document.querySelector('button[onclick="syncWithSynth()"]');
    btn.innerText = "‚è≥ SINCRONIZZANDO...";
    btn.disabled = true;

    try {
        const res = await fetch('/refresh_status');
        const data = await res.json();
        const lines = data.raw.split('\n');

        lines.forEach(line => {
            // Estrae il numero del canale e il nome dello strumento
            // Esempio: "chan 0, Grand Piano" -> ch: 0, name: "Grand Piano"
            const parts = line.split(',');
            if (parts.length >= 2) {
                const chan = parts[0].replace('chan', '').trim();
                const instrumentName = parts[1].trim();

                const dropdown = document.getElementById(`select-ch-${chan}`);
                if (dropdown) {
                    // Cerchiamo tra le opzioni quella che contiene il nome dello strumento
                    for (let option of dropdown.options) {
                        if (option.text.includes(instrumentName)) {
                            dropdown.value = option.value;
                            break;
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.error("Errore Sync:", e);
    } finally {
        btn.innerText = "üîÑ AGGIORNA STATO DA TASTIERA";
        btn.disabled = false;
    }
}

async function fetchSF2List() {
    try {
        // 1. Scarica la lista dei file
        const resList = await fetch('/list_sf2');
        const files = await resList.json();

        const select = document.getElementById('sf2-select');
        select.innerHTML = ""; 

        files.forEach(file => {
            let opt = document.createElement('option');
            opt.value = file;
            opt.innerHTML = file;
            select.appendChild(opt);
        });

        // 2. Scarica lo STATO ATTUALE (Font, Gain, Effetti)
        const resState = await fetch('/get_state');
        const state = await resState.json();

        console.log("Stato ricevuto dal server:", state); // Utile per debug

        // Imposta il Font corretto nel menu
        if (state.font) {
            select.value = state.font;
        }

// Aggiorna il Gain (Volume)
        if (state.gain) {
            const val = parseFloat(state.gain);

            // 1. Aggiorna il numeretto verde
            const badge = document.getElementById('gain-value');
            if (badge) badge.innerText = val.toFixed(1);
            
            // 2. Aggiorna la posizione dello Slider fisico
            // Cerchiamo l'input specifico che chiama la funzione "updateGain"
            const slider = document.querySelector('input[oninput*="updateGain"]');
            
            if (slider) {
                slider.value = val;
            }
        }


        // (Opzionale) Se vuoi sincronizzare anche gli slider degli effetti all'avvio:
        // Assicurati di dare id="reverb-slider" e id="chorus-slider" nel tuo HTML
        /*
        if (state['reverb.level']) {
            document.querySelector('input[onchange*="reverb.level"]').value = state['reverb.level'];
        }
        if (state['chorus.level']) {
            document.querySelector('input[onchange*="chorus.level"]').value = state['chorus.level'];
        }
        */

    } catch (e) {
        console.error("Errore sincronizzazione stato iniziale:", e);
    }
}



async function changeSF2(filename) {
    const select = document.getElementById('sf2-select');
    // Disabilita il select per evitare doppi click
    select.disabled = true;
    
    // Feedback visivo forte
    document.body.style.opacity = "0.3";
    document.body.style.cursor = "wait";
    
    // Lancia il comando
    await fetch(`/load_sf2/${filename}`);
    
    // ATTESA CRUCIALE: 4 secondi per permettere al Pi Zero di caricare il file in RAM
    setTimeout(() => {
        location.reload();
    }, 5000); 
}


// Chiama la funzione al caricamento
fetchSF2List();



        window.onload = setupMixer;
    </script>
</body>
</html>
